<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>è¸©åœ°é›· Minesweeper</title>
<style>
  :root{
    /* æ·ºç°æ£‹ç›¤ */
    --tile:#d7dbe2;
    --tile-open:#f3f5f8;
    --tile-border:#8a919d;
    --tile-size:34px;      /* æœƒç”± JS è¦†å¯« */
    --board-side:520px;    /* JS æœƒæŠŠæ£‹ç›¤å¤–æ¡†æ”¹ç‚ºæ­£æ–¹å½¢ */
    --accent:#0ea5a3;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:#0c1424;color:#0f1720}

  .container{max-width:980px;margin:18px auto;padding:14px}

  header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px}
  h1{margin:0;font-size:22px;color:#e6f1ff}
  .brand-sub{color:#9fb2c8;font-size:13px}

  /* è¡Œ1ï¼šé›£åº¦ + é‡ç½® + ç‹€æ…‹ */
  .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:10px 0 8px}
  .badge{padding:6px 10px;border-radius:10px;background:#e5e7eb;border:1px solid #cbd5e1;min-width:80px;text-align:center}
  select,input,button{
    background:#fff;border:1px solid #cbd5e1;color:#0f1720;padding:8px 10px;border-radius:10px
  }
  button{background:#0e344b;color:#fff;border-color:#0e344b;cursor:pointer}
  button:hover{filter:brightness(1.07)}

  /* è¡Œ2ï¼šè¡Œ/åˆ—/åœ°é›· åŒæ’ï¼Œçš†æœ‰æ¨™ç±¤æ–‡å­— */
  .triplet{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:6px 0 14px}
  .triplet .field{display:flex;gap:6px;align-items:center}
  .triplet label{font-weight:600;color:#e6f1ff}
  .triplet input{width:90px}

  /* æ£‹ç›¤å¤–æ¡†ï¼šç½®ä¸­ï¼‹æ­£æ–¹å½¢ */
  .board-shell{
    margin:0 auto;
    width:var(--board-side);
    height:var(--board-side);
    background:#fafafa;border:1px solid #d9dde6;border-radius:14px;padding:10px;
    display:flex;align-items:center;justify-content:center;
  }
  .board{display:grid}

  .tile{
    width:var(--tile-size); height:var(--tile-size);
    display:flex;align-items:center;justify-content:center;margin:2px;
    border-radius:8px;background:var(--tile);border:1px solid var(--tile-border);
    font-weight:700;color:#111827;font-size:14px;user-select:none;cursor:pointer;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.55);
  }
  .tile.open{background:var(--tile-open);border-color:#a3a9b3;color:#0f1720}
  .tile.flag{color:#0ea5a3}
  .tile.mine{color:#b91c1c;background:#f2b1b1;border-color:#9f1b1b}
  .tile.number-1{color:#1d4ed8}
  .tile.number-2{color:#15803d}
  .tile.number-3{color:#be123c}
  .tile.number-4{color:#7e22ce}
  .tile.number-5{color:#c2410c}
  .tile.number-6{color:#0891b2}
  .tile.number-7{color:#78350f}
  .tile.number-8{color:#374151}

  /* æœ€åº•ä¸‹çš„ç©æ³•èªªæ˜ */
  details.guide{background:#0f1a30;border:1px solid #1e2a44;border-radius:12px;padding:10px 12px;margin:14px 0}
  details.guide summary{cursor:pointer;color:#e6f1ff;font-weight:700}
  .guide-body{margin-top:6px;color:#c8d4e3;line-height:1.7}
  .kbd{display:inline-block;padding:2px 6px;border:1px solid #cbd5e1;border-radius:6px;background:#f8fafc;color:#111827;font-size:12px}

  /* å°è¢å¹•å¾®èª¿ */
  @media (max-width:640px){
    .triplet input{width:78px}
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>è¸©åœ°é›· Â· Minesweeper â€” ç¥ä½ æ‰‹æ°£å¥½ ğŸ€</h1>
      <div class="brand-sub">ç¬¬ä¸€æ­¥æ°¸é å®‰å…¨ï¼›è´äº†è«‹è·Ÿæˆ‘ç‚«è€€ä¸€ä¸‹ ğŸ˜†</div>
    </div>
  </header>

  <!-- è¡Œ1ï¼šé›£åº¦ + é‡ç½® + ç‹€æ…‹ -->
  <div class="bar">
    <label style="color:#e6f1ff;font-weight:700">é›£æ˜“åº¦
      <select id="preset">
        <option value="9x9x10">ç°¡å–® 9Ã—9 Â· 10</option>
        <option value="16x16x40">ä¸­ç­‰ 16Ã—16 Â· 40</option>
        <option value="16x30x99">å›°é›£ 16Ã—30 Â· 99</option>
        <option value="8x12x12">ä¼‘é–’ 8Ã—12 Â· 12</option>
      </select>
    </label>
    <button id="resetBtn">é‡ç½®</button>
    <div class="badge">å‰©é¤˜ï¼š<span id="mineCount">0</span></div>
    <div class="badge">æ™‚é–“ï¼š<span id="timer">0</span>s</div>
  </div>

  <!-- è¡Œ2ï¼šè¡Œ/åˆ—/åœ°é›· -->
  <div class="triplet">
    <div class="field"><label for="rows">è¡Œ</label><input id="rows" type="number" value="9" min="5" max="40"></div>
    <div class="field"><label for="cols">åˆ—</label><input id="cols" type="number" value="9" min="5" max="60"></div>
    <div class="field"><label for="mines">åœ°é›·</label><input id="mines" type="number" value="10" min="1"></div>
  </div>

  <!-- æ­£æ–¹å½¢æ£‹ç›¤å¤–æ¡†ï¼ˆJS æœƒè¨ˆç®—é‚Šé•·ï¼‰-->
  <div class="board-shell">
    <div id="board" class="board" aria-label="Minesweeper board"></div>
  </div>

  <!-- ç©æ³•èªªæ˜ï¼šæœ€åº•ä¸‹ï¼Œå¯æ”¶åˆ -->
  <details class="guide">
    <summary>ç©æ³•èªªæ˜ / æ“ä½œæç¤ºï¼ˆé»æˆ‘å±•é–‹/æ”¶åˆï¼‰</summary>
    <div class="guide-body">
      <p><strong>é›»è…¦ç‰ˆï¼š</strong> å·¦éµé–‹æ ¼ï¼›å³éµæ’æ——ï¼›<span class="kbd">F</span> æ’æ——ï¼›<span class="kbd">Space</span> é–‹æ ¼ï¼›æ–¹å‘éµç§»å‹•ç„¦é»ã€‚</p>
      <p><strong>æ‰‹æ©Ÿç‰ˆï¼š</strong> è¼•é»é–‹æ ¼ï¼›æŒ‰ä½ <span class="kbd">Alt</span> + é»æ“Šå¯æ’æ——ï¼ˆè‹¥ä½ çš„ç€è¦½å™¨æ”¯æ´å³éµ/é•·æŒ‰ï¼Œä¹Ÿå¯ä½¿ç”¨ï¼‰ã€‚</p>
      <ul>
        <li>ç¬¬ä¸€æ¬¡é»æ“Šå¾Œæ‰æœƒæ”¾åœ°é›·ï¼Œä¿è­‰å®‰å…¨ã€‚</li>
        <li>æ•¸å­—ä»£è¡¨å‘¨åœ 8 æ ¼çš„åœ°é›·æ•¸ï¼›æ­é–‹æ‰€æœ‰éåœ°é›·æ ¼å³å‹åˆ©ã€‚</li>
      </ul>
    </div>
  </details>
</div>

<script>
(() => {
  // DOM
  const boardEl  = document.getElementById('board');
  const presetEl = document.getElementById('preset');
  const rowsEl   = document.getElementById('rows');
  const colsEl   = document.getElementById('cols');
  const minesEl  = document.getElementById('mines');
  const resetBtn = document.getElementById('resetBtn');
  const mineCountEl = document.getElementById('mineCount');
  const timerEl  = document.getElementById('timer');
  const shellEl  = document.querySelector('.board-shell');

  // ç‹€æ…‹
  let rows=9, cols=9, totalMines=10;
  let grid=[]; let firstClick=true; let timer=null; let elapsed=0; let flagsPlaced=0; let gameOver=false; let cellsToReveal=0;

  // å·¥å…·
  const idx = (r,c)=> r*cols+c;
  const inBounds = (r,c)=> r>=0 && r<rows && c>=0 && c<cols;

  // === ç‰ˆé¢è¨ˆç®—ï¼šæŠŠæ£‹ç›¤ç¶­æŒæ­£æ–¹å½¢ä¸¦ç½®ä¸­ï¼Œæ ¼å­å¤§å°è‡ªå‹•ç¸®æ”¾ ===
  function layoutBoardSquare(){
    // å¯ç”¨å¯¬åº¦ï¼šå®¹å™¨å¯¬åº¦ï¼ˆ-å¤–æ¡†å…§è·ï¼‰
    const containerWidth = document.querySelector('.container').clientWidth;
    const shellPadding = 20; // board-shell padding: 10*2
    const usableWidth = containerWidth - 0; // shell æœƒè‡ªå·±ç®—

    // å¯ç”¨é«˜åº¦ï¼šè¦–çª—é«˜åº¦æ‰£æ‰ã€Œå®¹å™¨ä¸Šæ–¹åˆ°æ£‹ç›¤ä¸Šç·£ã€çš„è·é›¢ï¼Œå†ç•™ä¸€é»ç©ºé–“çµ¦èªªæ˜/åº•éƒ¨
    const rectTopToShellTop = document.querySelector('.container').getBoundingClientRect().top
      + document.querySelector('header').offsetHeight
      + document.querySelector('.bar').offsetHeight
      + document.querySelector('.triplet').offsetHeight
      + 28; // é¡å¤–ç·©è¡

    const usableHeight = Math.max(260, window.innerHeight - rectTopToShellTop - 160); // åº•éƒ¨ç•™å‡ºèªªæ˜ç©ºé–“

    const side = Math.floor(Math.min(usableWidth, usableHeight));
    document.documentElement.style.setProperty('--board-side', side + 'px');

    // ä¾ side èˆ‡ cols è¨­å®š tile å°ºå¯¸ï¼ˆå«æ¯æ ¼ margin 2pxï¼‰
    const gaps = cols * 4; // å·¦å³ margin 2+2
    let size = Math.floor((side - shellPadding - gaps) / cols);
    size = Math.max(20, Math.min(size, 48));  // é™åˆ¶ç¯„åœï¼Œé¿å…å¤ªå°/å¤ªå¤§
    document.documentElement.style.setProperty('--tile-size', size + 'px');

    // æ›´æ–° grid æ¨¡æ¿
    boardEl.style.gridTemplateColumns = `repeat(${cols}, var(--tile-size))`;
    boardEl.style.gridTemplateRows    = `repeat(${rows}, var(--tile-size))`;
  }

  // === æ£‹ç›¤è³‡æ–™ ===
  function createGrid(){
    grid = new Array(rows*cols);
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        grid[idx(r,c)] = { r,c, mine:false, open:false, flagged:false, adj:0, el:null };
      }
    }
  }

  function placeMinesAvoiding(firstR, firstC){
    const forbidden = new Set();
    for(let dr=-1;dr<=1;dr++){
      for(let dc=-1;dc<=1;dc++){
        const rr=firstR+dr, cc=firstC+dc;
        if(inBounds(rr,cc)) forbidden.add(idx(rr,cc));
      }
    }
    let placed=0, total=rows*cols;
    while(placed<totalMines){
      const pos = Math.floor(Math.random()*total);
      if(forbidden.has(pos)) continue;
      const cell = grid[pos];
      if(!cell.mine){ cell.mine=true; placed++; }
    }
    // è¨ˆç®—é„°é›·æ•¸
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const cell = grid[idx(r,c)];
        if(cell.mine){ cell.adj=-1; continue; }
        let cnt=0;
        for(let dr=-1;dr<=1;dr++){
          for(let dc=-1;dc<=1;dc++){
            if(dr===0&&dc===0) continue;
            const rr=r+dr, cc=c+dc;
            if(inBounds(rr,cc) && grid[idx(rr,cc)].mine) cnt++;
          }
        }
        cell.adj = cnt;
      }
    }
  }

  function buildBoard(){
    boardEl.innerHTML='';
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const cell=grid[idx(r,c)];
        const el=document.createElement('div');
        el.className='tile';
        el.dataset.r=r; el.dataset.c=c;
        el.addEventListener('click', ev=>handleLeftClick(ev,cell));
        el.addEventListener('contextmenu', ev=>handleRightClick(ev,cell));
        el.addEventListener('auxclick', ev=>{ if(ev.button===1) handleRightClick(ev,cell); });
        cell.el=el;
        boardEl.appendChild(el);
      }
    }
    layoutBoardSquare();
  }

  // === éŠæˆ²æµç¨‹ ===
  function startTimer(){ if(timer) clearInterval(timer); elapsed=0; timerEl.textContent='0'; timer=setInterval(()=>{elapsed++; timerEl.textContent=elapsed;},1000); }
  function stopTimer(){ if(timer){ clearInterval(timer); timer=null; } }

  function revealCell(cell){
    if(cell.open || cell.flagged) return;
    cell.open=true; cell.el.classList.add('open');
    if(cell.mine){ cell.el.classList.add('mine'); cell.el.textContent='ğŸ’£'; return; }
    cellsToReveal--;
    if(cell.adj>0){ cell.el.classList.add('number-'+cell.adj); cell.el.textContent=cell.adj; }
    else{
      for(let dr=-1;dr<=1;dr++){
        for(let dc=-1;dc<=1;dc++){
          if(dr===0&&dc===0) continue;
          const rr=cell.r+dr, cc=cell.c+dc;
          if(inBounds(rr,cc)){
            const n=grid[idx(rr,cc)];
            if(!n.open && !n.flagged && !n.mine) revealCell(n);
          }
        }
      }
    }
  }

  function handleLeftClick(ev, cell){
    if(gameOver) return;
    if(ev.altKey) return toggleFlag(cell);
    if(firstClick){ placeMinesAvoiding(cell.r, cell.c); startTimer(); firstClick=false; }
    if(cell.flagged || cell.open) return;
    if(cell.mine){ revealAllMines(cell); return endGame(false); }
    revealCell(cell); checkWin();
  }
  function handleRightClick(ev, cell){ ev.preventDefault(); if(gameOver||cell.open) return; toggleFlag(cell); }

  function toggleFlag(cell){
    if(cell.open) return;
    cell.flagged = !cell.flagged;
    cell.el.classList.toggle('flag', cell.flagged);
    cell.el.textContent = cell.flagged ? 'ğŸš©' : '';
    flagsPlaced += cell.flagged ? 1 : -1;
    updateMineCount();
  }

  function revealAllMines(triggerCell){
    for(const c of grid){
      if(c.mine){
        c.el.classList.add('open','mine');
        if(!c.flagged) c.el.textContent='ğŸ’£';
      }
      if(c.flagged && !c.mine){
        c.el.textContent='âŒ'; c.el.classList.add('open');
      }
    }
    if(triggerCell) triggerCell.el.classList.add('mine');
  }

  function checkWin(){
    if(cellsToReveal===0 && !gameOver){
      for(const c of grid){ if(c.mine && !c.flagged){ c.flagged=true; c.el.classList.add('flag'); c.el.textContent='ğŸš©'; } }
      endGame(true);
    }
  }

  function endGame(won){
    gameOver=true; stopTimer();
    setTimeout(()=> alert(won ? `ä½ è´äº†ï¼ç”¨æ™‚ ${elapsed} ç§’ ğŸ‰` : 'ä½ è¸©åˆ°åœ°é›·äº† ğŸ’¥ éŠæˆ²çµæŸ'), 40);
  }

  function updateMineCount(){ mineCountEl.textContent = Math.max(0, totalMines - flagsPlaced); }

  function resetGame(){
    rows = +rowsEl.value || 9;
    cols = +colsEl.value || 9;
    totalMines = +minesEl.value || 10;

    // ä¸Šé™é˜²å‘†
    const maxM = Math.floor(rows*cols*0.6);
    if(totalMines >= rows*cols){ totalMines = Math.max(1, rows*cols-1); minesEl.value = totalMines; }
    if(totalMines > maxM){ totalMines = maxM; minesEl.value = totalMines; }

    firstClick=true; gameOver=false; flagsPlaced=0; stopTimer();
    timerEl.textContent='0'; mineCountEl.textContent=totalMines;
    cellsToReveal = rows*cols - totalMines;

    createGrid(); buildBoard();  // æœƒä¸€èµ·ç®—æ’ç‰ˆèˆ‡ tile å°ºå¯¸
  }

  // äº‹ä»¶ï¼šé›£åº¦/è¼¸å…¥è®Šæ›´/é‡ç½®/è¦–çª—å°ºå¯¸æ”¹è®Š
  presetEl.addEventListener('change', ()=>{
    const v = presetEl.value.split('x').map(Number);
    if(v.length===3){ rowsEl.value=v[0]; colsEl.value=v[1]; minesEl.value=v[2]; resetGame(); }
  });
  [rowsEl, colsEl, minesEl].forEach(el => el.addEventListener('change', ()=>{ presetEl.value=''; resetGame(); }));
  resetBtn.addEventListener('click', resetGame);
  window.addEventListener('resize', layoutBoardSquare);
  window.addEventListener('orientationchange', layoutBoardSquare);

  // åˆå§‹åŒ–
  resetGame();

  // debug
  window._ms = { layoutBoardSquare, resetGame };
})();
</script>
</body>
</html>
