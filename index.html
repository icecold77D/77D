<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>J17·77D·故事</title>
  <style>
    :root{
      --bg:#0b0b0c; --fg:#f4f4f5; --muted:#a1a1aa;
      --card:#151518; --border:#232329; --accent:#8b5cf6;
      --card-w: 220px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto}
    header{position:sticky;top:0;z-index:20;background:linear-gradient(#0b0b0c,rgba(11,11,12,.85));border-bottom:1px solid rgba(255,255,255,.06)}
    .wrap{max-width:1280px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px}
    .muted{color:var(--muted);font-size:13px}
    section{margin-top:18px}
    .row-head{display:flex;align-items:center;justify-content:space-between;padding:6px 2px}
    .row-title{font-size:16px;margin:0}
    .rail-wrap{position:relative}
    .rail{
      display:flex; gap:12px; padding:6px 0 14px;
      overflow:auto; scroll-snap-type:x proximity;
      scrollbar-width:none;
    }
    .rail::-webkit-scrollbar{display:none}
    .card{
      flex:0 0 var(--card-w); width:var(--card-w);
      background:var(--card); border:1px solid var(--border);
      border-radius:14px; overflow:hidden; text-decoration:none; color:inherit;
      scroll-snap-align:start; transition:transform .18s ease, border-color .18s ease, box-shadow .18s ease;
      cursor:pointer;
    }
    .card:hover{transform:translateY(-3px); border-color:#3a3a45; box-shadow:0 10px 24px rgba(0,0,0,.35)}
    .thumb{
      width:100%; display:block; aspect-ratio:16/9; object-fit:cover; background:#0f0f12;
      -webkit-user-drag:none; user-select:none; pointer-events:none;
    }
    .cap{padding:8px 10px; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; border-top:1px solid var(--border)}
    .nav{
      position:absolute; top:50%; transform:translateY(-50%);
      width:40px; height:40px; border-radius:999px; border:1px solid var(--border);
      background:rgba(21,21,24,.75); color:var(--fg); backdrop-filter:blur(6px);
      display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none;
      transition:background .15s ease, transform .15s ease;
      z-index:5;
    }
    .nav:hover{background:rgba(40,40,48,.9)}
    .nav.left{left:-6px} .nav.right{right:-6px}
    .nav[hidden]{display:none}
    .empty{color:var(--muted); padding:24px 8px}
    @media (max-width: 768px){
      :root{ --card-w: 180px; }
      .wrap{padding:12px}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>📺 歡迎來到七隻阿清的小天地</h1>
      <div class="muted">左右滑動每一排；點縮圖進入該領域小故事 </div>
    </div>
  </header>

  <main class="wrap" id="app">
    <p class="muted">正在載入資料…</p>
  </main>

  <script>
    const el = (tag, cls, html) => {
      const n = document.createElement(tag);
      if (cls) n.className = cls;
      if (html != null) n.innerHTML = html;
      return n;
    };

    // 取得每次「跳一張卡片」需要的位移（卡片寬度 + gap）
    function getStep(rail){
      const card = rail.querySelector('.card');
      if (!card) return rail.clientWidth; // 後備
      const rect = card.getBoundingClientRect();
      const gap = parseFloat(getComputedStyle(rail).gap || '0') || 0;
      return rect.width + gap;
    }

    // 使滾輪為水平、支援拖曳、拖完吸附到最近卡片；點擊不被吃掉
    function enhanceRailScroll(rail){
      // 滑鼠滾輪：垂直滾＝水平捲
      rail.addEventListener('wheel', (e) => {
        if (Math.abs(e.deltaX) < Math.abs(e.deltaY)) {
          rail.scrollLeft += e.deltaY;
          e.preventDefault();
          scheduleSnap(); // 停止滾動後吸附
        }
      }, { passive:false });

      let isDown = false, isDragging = false;
      let startX = 0, startScrollLeft = 0;
      const DRAG_THRESHOLD = 5;

      rail.addEventListener('pointerdown', (e) => {
        isDown = true;
        isDragging = false;
        startX = e.clientX;
        startScrollLeft = rail.scrollLeft;
      });

      rail.addEventListener('pointermove', (e) => {
        if (!isDown) return;
        const dx = e.clientX - startX;
        if (!isDragging && Math.abs(dx) > DRAG_THRESHOLD) {
          isDragging = true;
          rail.setPointerCapture(e.pointerId);
          rail.style.cursor = 'grabbing';
        }
        if (isDragging) {
          rail.scrollLeft = startScrollLeft - dx;
        }
      });

      function endDrag(e){
        if (!isDown) return;
        isDown = false;
        rail.style.cursor = '';
        try { rail.releasePointerCapture(e.pointerId); } catch {}
        if (isDragging) {
          // 吃掉隨後可能觸發的 click
          const blocker = (ev) => { ev.stopPropagation(); ev.preventDefault(); rail.removeEventListener('click', blocker, true); };
          rail.addEventListener('click', blocker, true);
          snapToNearest();
        }
        isDragging = false;
      }
      rail.addEventListener('pointerup', endDrag);
      rail.addEventListener('pointercancel', endDrag);
      rail.addEventListener('pointerleave', endDrag);

      // 鍵盤：左右鍵每次跳一張（讓 rail 可聚焦）
      rail.tabIndex = 0;
      rail.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight' || e.key === 'ArrowLeft'){
          e.preventDefault();
          const step = getStep(rail);
          const dir = e.key === 'ArrowRight' ? 1 : -1;
          rail.scrollBy({ left: dir * step, behavior: 'smooth' });
          scheduleSnap();
        }
      });

      // 停一小段時間就吸附到最近卡片
      let snapTimer = null;
      function scheduleSnap(){
        clearTimeout(snapTimer);
        snapTimer = setTimeout(snapToNearest, 120);
      }
      function snapToNearest(){
        const step = Math.max(1, getStep(rail));
        const target = Math.round(rail.scrollLeft / step) * step;
        rail.scrollTo({ left: target, behavior: 'smooth' });
      }
    }

    // 建立一行（分類）
    function makeRow(section){
      // section: { title, items: [ {name,img,href,date?} ] }
      const container = el('section');

      const head = el('div', 'row-head');
      head.appendChild(el('h2', 'row-title', section.title || '未命名分類'));
      container.appendChild(head);

      if (!Array.isArray(section.items) || section.items.length === 0){
        container.appendChild(el('div', 'empty', '此分類目前沒有項目'));
        return container;
      }

      // 依 date 新→舊
      const items = [...section.items];
      items.sort((a,b)=>{
        const da = Date.parse(a.date || '') || 0;
        const db = Date.parse(b.date || '') || 0;
        return db - da;
      });

      const railWrap = el('div', 'rail-wrap');
      const rail = el('div', 'rail');

      items.forEach(it=>{
        const a = el('a', 'card');
        a.href = it.href;
        a.innerHTML = `
          <img class="thumb" src="${it.img}" alt="${it.name || ''}" loading="lazy">
          <div class="cap">${it.name || ''}</div>
        `;
        rail.appendChild(a);
      });
      railWrap.appendChild(rail);

      const navL = el('div', 'nav left', '‹');
      const navR = el('div', 'nav right', '›');
      railWrap.appendChild(navL);
      railWrap.appendChild(navR);

      // 每次按鈕點擊：精準跳一張
      const jumpOne = (dir) => {
        const step = getStep(rail);
        rail.scrollBy({ left: dir * step, behavior:'smooth' });
      };
      navL.addEventListener('click', ()=> jumpOne(-1));
      navR.addEventListener('click', ()=> jumpOne(1));

      // 只有超出寬度時才顯示箭頭
      const toggleNav = () => {
        const overflow = rail.scrollWidth > rail.clientWidth + 4;
        navL.hidden = navR.hidden = !overflow;
      };
      const ro = new ResizeObserver(toggleNav);
      ro.observe(rail);
      toggleNav();

      enhanceRailScroll(rail);
      container.appendChild(railWrap);
      return container;
    }

    async function boot(){
      const app = document.getElementById('app');
      const url = new URL('./data.json', location.href);
      url.searchParams.set('v', Date.now()); // 破快取
      try{
        const r = await fetch(url.toString(), { cache: 'no-store' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const data = await r.json();

        // 期望 data 為：[{title:"美食類", items:[{name,img,href,date}, ...]}, ...]
        if (!Array.isArray(data) || data.length === 0){
          app.innerHTML = '<p class="muted">目前沒有任何分類</p>';
          return;
        }

        app.innerHTML = '';
        data.forEach(section => app.appendChild(makeRow(section)));
      }catch(err){
        app.innerHTML = `<p class="muted" style="color:#f88">載入失敗：${err.message}</p>`;
      }
    }
    boot();
  </script>
</body>
</html>
